# Static IR Analysis

:alarm_clock: *Last update: 4/10/25*

This guide shows how we can analyze the current grid structure's static IR drop. This is essential to check if the power grid is robust.

You need to prepare the following:
- **Innovus design database**: Your current innovus design database. The database is of type `.dat` generated by the `saveDesign` command in Innovus.
- **PGV view libraries**: Make sure to check the [PGV Generation Steps](../pgv_gen/README.md) first. This is mandatory because it will create the resistance grids you need.
- **(Optional) EM model**: This optional file is needed to also display the electron migration (EM) information. This is useful to see how much allowable current goes through each wire.

# Static IR Analysis Steps

There are two major steps in doing static IR analysis. The 1st step is to generate average power, and the 2nd step is to annotate and analyze the average power. The steps are embedded in the [`static_ir.tcl`](./static_ir.tcl) script.


# Static IR Setup

## 1. Setup multiprocessing.

```tcl
# 1. Set multiprocessing
set_multi_cpu_usage -cpuPerRemoteHost 64 -remoteHost 64
```

## 2. Load existing design.

In this step, you need to load your current Innovus design. This is from the `saveDesign` command that you run.

```tcl
# 2. Load design database
read_design -physical_data $designdb_dir_path/project.inn.dat project_top
```

## 3. Update target SDC constraints

:warning: Update the timing SDC constraints. You need to update this because the default setting when reloading from Innovus uses the last saved SDC constraint. So, if you want to analyze your current design at a different frequency, you have to manually load a new SDC constraint.

```tcl
# 3. Make sure to set target SDC constraints
set_interactive_constraint_modes [all_constraint_modes -active]
update_constraint_mode -name target_mode -sdc_files $sdc_dir_path/target.sdc
set_propagated_clock [ all_clocks ]
```


## 4. Update the current views

This is necessary for the current views to also update with the new SDC constraints.

```tcl
# 4. Update and set the analysis views
set_analysis_view \
-setup [list \
   AV_TT_0P750V_085C_setup_worst_rcworst \
   AV_TT_0P800V_025C_setup_worst_typical \
] \
-hold [list \
   AV_FF_0P88V_0C_hold_best_rcbest \
   AV_TT_0P800V_025C_hold_best_typical \
   AV_TT_0P800V_025C_hold_worst_typical \
   AV_TT_0P750V_085C_hold_worst_rcworst \
]
```

## 5. Define power analysis mode

In this step, only the `-method` and `-analysis_view` are important. The `-method` needs to be static so that it can generated averaged switching values which will be used later. For the `-analysis_view`, it is *recommended* to anaylze at the FF corner. Make sure to select the appropriate view for this.

:exclamation: The different from FF corner to slower ones (i.e. TT or SS) is not too drastic. However, FF is still the worst case due to leakage.

```tcl
# 5. Define power analysis mode
set_power_analysis_mode \
  -method static \
  -analysis_view AV_FF_0P88V_0C_hold_best_rcbest \
  -create_binary_db true \
  -write_static_currents true \
  -honor_negative_energy true \
  -ignore_control_signals true
```

# 6. Setting up power analysis settings

- Here we setup a the log directory. Make sure to take note of this log directory since this is where you will find `.ptiavg` files which are needed for static IR drop analysis. 
- There is a switching activity setting that annotates logic that don't have default values. However, your SDC step overrides the `-period` option for this. A 20% setting is conservative enough (also usually the default).

```tcl
# 6. Setting up power analysis

# Simply set where to dump the output
set_power_output_dir $log_dir_path/power_analysis

# Set target switching activity for un-annotated logic
set_default_switching_activity -reset
set_default_switching_activity -input_activity 0.20 -period 1.5 -global_activity 0.20
```

## 7. Generating power reports

- `report_power -rail_analysis_format VS` is the one that we need for static IR analysis. This will generate a summarized report and the required `.ptiavg` file. The file is like a `saif` where it contains all averaged switching annotation.

- `report_power -cell_type all` is optional but a useful debugging report. :warning: Be warned that this file can be huge. This is as good as a "hierarchical" report. You can also find information on the annotated switching, clock network power, and each the power for each block.

```tcl
# 7. Generating power reports

# Generates also the .ptiavg data which we need
report_power -rail_analysis_format VS -outfile $log_dir_path/power_analysis/project_power_ffcorner.rpt

# Optional but useful for analysis
report_power -cell_type all -outfile $log_dir_path/power_analysis/project_power_ffcorner_celltype_all.rpt
```

## 8. (Optional) Setting EM analysis mode

This part maybe optional but it is *highly recommended* to add as well. The EM analysis makes it useful for you to check if you have too much current draw. Basically, it measures the current density for each metal layer (or wire). You need to check with the DRC manual (or possibly some release notes) to know the maximum current draw (or current density). It is highly recommended to add this so that you can do normal rail analysis with EM analysis added. Run-time does not increase much.

- `ict_em_models` is the most important option. You need to ask or find in your foundry's technology and look for a `.ictem` or `.em` file. This contains information about your current density. This differs per metallization layer.

```tcl
# 8. (Optional) Setting up EM analysis mode
set_signal_em_analysis_mode \
  -method {rms peak avg} \
  -detailed true \
  -useQrcTech true \
  -ict_em_models {$em_dir_path/technology.ictem}
```

## 9. Setting rail analysis mode

This step sets the rail analysis that you want to process.

- `method` is obviously `static`.
- `accuracy` needs to be `hd`. This is the highest accuracy and calculates IR drop meticulously. There is an option for `early` which is faster but less accurate.
- `ict_em_models` is optional but if you set it previously in step 8, then add it here too.
- `em_peak_analysis` also optional but if you set EM analysis, you add this here too.
- `force_library_merging` :warning: this option is usually added because sometimes when you generate your own PGV, it may not match those that were pre-generated by others. For example, the standard cell PGV would most likely be generated by your foundry. However, when you generate your own PGV for custom IPs (e.g., memories) they may not match as to how the foundry generated the standard cells. That is fine. So they have this `force_library_merging` option to merge even with mismatches. The mismatch error will appear anyway and you can use it to debug. However, if there is a mismatch and it's probably due to wiring and via resistances, that should be okay to override.
- `power_grid_library` this is where you need to plase **all** PGV views. You need to make sure that all cells used (i.e., standard cells, memories, custom IPs) need to be included. Otherwise, you will see disconnections from your design.

```tcl
# 9. Setting rail analysis mode

# Reset for to make sure
set_rail_analysis_mode -reset

# Actual setting of rail analysis mode
set_rail_analysis_mode -method static \
                       -accuracy hd \
                       -extraction_tech_file "$qrc_dir_path/typical/Tech/typical/qrcTechFile" \
                       -ict_em_models {$em_dir_path/technology.ictem} \
                       -em_peak_analysis true \
                       -force_library_merging true \
                       -power_grid_library {  
                            pgv_dir_path/sram_512x32b.cl \
                            pgv_dir_path/sram_256x64b.cl \
                            pgv_dir_path/sram_256x128b.cl \
                            pgv_dir_path/std_cell.cl \
                            pgv_dir_path/clk_gen.cl \
                            pgv_dir_path/dimc.cl \
                        }
```

Once this is set, you need to go to your GUI for running the rail analysis. This is the end of setting up the static IR analysis.

# Running Static IR

From here on, it is better to use the GUI instead.

## 1. Opening rail anaylsis

In the Voltus tabs, open `Power Rail -> Run Rail Analysis`

![image](https://github.com/user-attachments/assets/ecdd424a-e331-4a41-b470-afc4f081bb54)

:warning: If the `Run Rail Analysis` cannot be selected. That is because you haven't set or run the `set_rail_analysis_mode`. See step number 9 from the previous section.

## 2. Setting up the Run Rail Analysis

Once opened, you should see the `Run Rail Analysis` window and fill in the corresponding settings accordingly.

![image](https://github.com/user-attachments/assets/d738719b-2ae5-459d-95fc-b72dc9e5b4a8)

- In the 1st box, make sure to select `Net Based` option, and fill in the `Power Net(s)` box to the target analysis. In our case we use the `VDD_STDCELL`, this name needs to coincide with the power name you have in your Innovus database. Set the appropriate `Voltage(s)`. In this case, we use 0.8 V. The threshold needs to be 2.5% of the swing so in this case that is 20 mV of the supply.
- In the 2nd box, select `Current Files` as the power data. Navigate to where you saved the `$log_dir_path/power_analysis/` directory. You should find the `.ptiavg` file with the voltage target.
- In the last box, you need to select `XY File` which is a new file you have to add. This is the pad points file which contains information about where your power supply points will come from. You would usually place this on top of your pad. The `project.VDD.pp` file has the following format:

```text
*vsrc_name   x   y   layer_name
VDD_STDCELL_0 14.7 380 M12
VDD_STDCELL_1 14.7 864 M12
VDD_STDCELL_2 14.7 1154 M12
VDD_STDCELL_3 14.7 1280 M12
VDD_STDCELL_4 14.7 1405 M12
VDD_STDCELL_5 14.7 1831 M12
VDD_STDCELL_6 14.7 2454 M12
```

The `*vsrc_name` is the name of the voltage source (you can give it any name). `x` and `y` are the point locations on where you want to place a voltage source. Lastly, the `layer_name` is where that voltage source would be placed. You would  usually place it on the top-most layer or on the pad layer.

- For the last box still, don't forget to click the add button to add it to the list.
- When finish, just click `OK` and the rail analysis will run.




